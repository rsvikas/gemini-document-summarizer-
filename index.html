<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Document Summarizer (Powered by Gemini)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- Office Document Parsers -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <!-- Babel for in-browser JSX/TS transpilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <style>
    /* Custom scrollbar for the summary box to ensure it's always visible */
    .summary-content::-webkit-scrollbar {
      width: 8px;
    }
    .summary-content::-webkit-scrollbar-track {
      background: #1e293b; /* slate-800 */
    }
    .summary-content::-webkit-scrollbar-thumb {
      background-color: #475569; /* slate-600 */
      border-radius: 4px;
      border: 2px solid #1e293b; /* slate-800 */
    }
    .summary-content::-webkit-scrollbar-thumb:hover {
      background-color: #64748b; /* slate-500 */
    }
    /* For Firefox */
    .summary-content {
      scrollbar-width: thin;
      scrollbar-color: #475569 #1e293b;
    }
  </style>

  <script type="importmap">
  {
    "imports": {
      "react": "https://esm.sh/react@18.2.0",
      "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
      "@google/genai": "https://esm.sh/@google/genai"
    }
  }
  </script>
</head>
  <body class="bg-slate-900 text-slate-200">
    <div id="root"></div>
    <script type="text/babel" data-type="module">
      import React, { useState, useCallback, useRef, useEffect } from 'react';
      import ReactDOM from 'react-dom/client';
      import { GoogleGenAI } from '@google/genai';
      
      // --- Inlined from: types.ts ---
      const ProcessingState = {
        INITIALIZING: 'INITIALIZING',
        IDLE: 'IDLE',
        EXTRACTING: 'EXTRACTING',
        SUMMARIZING: 'SUMMARIZING',
        SUCCESS: 'SUCCESS',
        ERROR: 'ERROR',
      };

      // --- Inlined from: components/icons.tsx ---
      const UploadIcon = () => (
        <svg xmlns="http://www.w3.org/2000/svg" className="h-10 w-10 mb-3 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
        </svg>
      );

      const Loader = ({ statusText }) => (
          <div className="flex flex-col items-center justify-center text-center p-8">
              <svg className="animate-spin h-12 w-12 text-sky-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                  <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              <p className="mt-4 text-lg font-medium text-slate-300 transition-all duration-300">{statusText}</p>
          </div>
      );

      const DocumentIcon = () => (
          <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 mr-3 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
      );

      // --- Inlined from: services/libraryVerifier.ts ---
      const waitForLibraries = (timeout = 10000) => {
          const startTime = Date.now();
          const requiredLibraries = ['pdfjsLib', 'mammoth', 'XLSX'];

          return new Promise((resolve, reject) => {
              const checkLibraries = () => {
                  const allLoaded = requiredLibraries.every(lib => typeof window[lib] !== 'undefined');

                  if (allLoaded) {
                      resolve();
                  } else if (Date.now() - startTime > timeout) {
                      const missing = requiredLibraries.filter(lib => typeof window[lib] === 'undefined');
                      reject(new Error(`Could not load required document parsers: ${missing.join(', ')}`));
                  } else {
                      setTimeout(checkLibraries, 100);
                  }
              };
              checkLibraries();
          });
      };
      
      // --- Inlined from: services/fileUtils.ts ---
      const extractTextFromFile = async (file) => {
          const reader = new FileReader();

          return new Promise((resolve, reject) => {
            reader.onload = async (event) => {
              try {
                if (!event.target?.result) {
                  return reject(new Error("File could not be read."));
                }
                
                const buffer = event.target.result;
                let text = '';
                
                if (file.type === 'application/pdf') {
                  const { pdfjsLib } = window;
                  pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js`;
                  const pdf = await pdfjsLib.getDocument({ data: new Uint8Array(buffer) }).promise;
                  let content = [];
                  for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    content.push(textContent.items.map((item) => item.str).join(' '));
                  }
                  text = content.join('\n');
                } else if (file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') {
                  const result = await window.mammoth.extractRawText({ arrayBuffer: buffer });
                  text = result.value;
                } else if (file.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet') {
                  const workbook = window.XLSX.read(buffer, { type: 'buffer' });
                  let content = [];
                  workbook.SheetNames.forEach((sheetName) => {
                    const roa = window.XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1 });
                    if (roa.length) content.push(roa.map((row) => row.join("\t")).join("\n"));
                  });
                  text = content.join('\n\n');
                } else if (file.type === 'text/plain' || file.type === 'text/markdown') {
                  text = new TextDecoder().decode(buffer);
                } else {
                  throw new Error(`Unsupported file type: ${file.type}`);
                }
                resolve(text);
              } catch (err) {
                reject(err);
              }
            };
            reader.onerror = (err) => reject(err);
            reader.readAsArrayBuffer(file);
          });
        };
      
      // --- Inlined from: App.tsx ---
      const App = () => {
        const [processingState, setProcessingState] = useState(ProcessingState.INITIALIZING);
        const [summary, setSummary] = useState('');
        const [error, setError] = useState(null);
        const [extractedText, setExtractedText] = useState('');
        const [fileName, setFileName] = useState('');
        
        const fileInputRef = useRef(null);

        useEffect(() => {
          const initializeApp = async () => {
              try {
                  await waitForLibraries();
                  setProcessingState(ProcessingState.IDLE);
              } catch (err) {
                  setError(`Initialization failed: ${err.message}`);
                  setProcessingState(ProcessingState.ERROR);
              }
          };
          initializeApp();
        }, []);

        const resetState = useCallback(() => {
          setProcessingState(ProcessingState.IDLE);
          setSummary('');
          setError(null);
          setExtractedText('');
          setFileName('');
          if(fileInputRef.current) {
              fileInputRef.current.value = '';
          }
        }, []);

        const handleSummarize = async (text) => {
          if (!process.env.API_KEY) {
            setError("API_KEY environment variable not set. This is required for Google Gemini.");
            setProcessingState(ProcessingState.ERROR);
            return;
          }

          try {
            const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
            const model = 'gemini-2.5-flash';
            const prompt = `Please provide a concise summary of the following document:\n\n---\n\n${text}`;

            const response = await ai.models.generateContent({
              model: model,
              contents: prompt,
            });
            
            const summaryText = response.text;
            
            if (summaryText) {
                setSummary(summaryText.trim());
                setProcessingState(ProcessingState.SUCCESS);
            } else {
                setError("The model could not generate a summary for this document.");
                setProcessingState(ProcessingState.ERROR);
            }
          } catch (err) {
            console.error(err);
            let errorMessage = `An error occurred during summarization: ${err.message}`;
            if (err.message?.includes('429')) {
                errorMessage = "API rate limit exceeded. Please wait a moment and try again.";
            } else if (err.message?.includes('SAFETY')) {
                errorMessage = "The content could not be processed due to safety policies. Please check the document for any sensitive material.";
            } else if (err.message?.includes('API key not valid')) {
                errorMessage = "The provided Google AI API key is not valid. Please check your configuration.";
            }
            setError(errorMessage);
            setProcessingState(ProcessingState.ERROR);
          }
        };

        const handleFileChange = async (event) => {
          const file = event.target.files?.[0];
          if (!file) return;

          resetState();
          setFileName(file.name);
          setProcessingState(ProcessingState.EXTRACTING);

          try {
              const text = await extractTextFromFile(file);
              setExtractedText(text);
              if (text.trim().length === 0) {
                  setError('Could not extract any text from the document.');
                  setProcessingState(ProcessingState.ERROR);
                  return;
              }
              
              setProcessingState(ProcessingState.SUMMARIZING);
              setTimeout(() => {
                handleSummarize(text);
              }, 50);

          } catch (err) {
              setError(`Failed to process file: ${err.message}`);
              setProcessingState(ProcessingState.ERROR);
          }
        };
        
        const handleDragOver = (e) => e.preventDefault();
        const handleDrop = (e) => {
          e.preventDefault();
          if (fileInputRef.current && e.dataTransfer.files && e.dataTransfer.files[0]) {
            fileInputRef.current.files = e.dataTransfer.files;
            const changeEvent = new Event('change', { bubbles: true });
            fileInputRef.current.dispatchEvent(changeEvent);
          }
        };
        
        const handleFileClick = () => fileInputRef.current?.click();

        const renderContent = () => {
          switch (processingState) {
            case ProcessingState.INITIALIZING:
              return <Loader statusText="Initializing document parsers..." />;
            case ProcessingState.IDLE:
              return (
                <div 
                  className="flex flex-col items-center justify-center w-full h-full p-8 border-2 border-dashed border-slate-600 rounded-lg cursor-pointer hover:bg-slate-800 transition-colors"
                  onDragOver={handleDragOver}
                  onDrop={handleDrop}
                  onClick={handleFileClick}
                  role="button"
                  aria-label="File upload area"
                  tabIndex={0}
                  onKeyDown={(e) => e.key === 'Enter' && handleFileClick()}
                >
                  <UploadIcon />
                  <p className="text-lg font-semibold text-slate-300">Drag & drop a document here</p>
                  <p className="text-slate-500">or click to select a file</p>
                  <p className="text-xs text-slate-600 mt-4">Supports: PDF, DOCX, XLSX, TXT, MD</p>
                  <input
                    ref={fileInputRef}
                    type="file"
                    className="hidden"
                    onChange={handleFileChange}
                    accept=".pdf,.docx,.xlsx,.txt,.md"
                    aria-hidden="true"
                  />
                </div>
              );
            case ProcessingState.EXTRACTING:
                return <Loader statusText="Extracting text from document..." />;
            case ProcessingState.SUMMARIZING:
              return <Loader statusText="Summarizing with Google AI..." />;
            case ProcessingState.ERROR:
              return (
                <div className="text-center p-8">
                  <h3 className="text-xl font-semibold text-red-400 mb-4">Processing Failed</h3>
                  <p className="bg-red-900/50 border border-red-700 text-red-300 p-4 rounded-md">{error}</p>
                </div>
              );
            case ProcessingState.SUCCESS:
              return (
                <div className="w-full p-6 space-y-6">
                  <div>
                      <div className="flex items-center mb-2">
                          <DocumentIcon />
                          <h3 className="text-xl font-bold text-sky-400">{fileName}</h3>
                      </div>
                      <h4 className="text-lg font-semibold text-slate-200 mb-2">Summary</h4>
                      <div className="summary-content bg-slate-800 p-4 rounded-lg max-h-96 overflow-y-auto whitespace-pre-wrap">
                        {summary}
                      </div>
                  </div>
                  <div>
                    <h4 className="text-lg font-semibold text-slate-200 mb-2">Original Text</h4>
                    <textarea
                      readOnly
                      value={extractedText}
                      className="w-full h-48 bg-slate-950 border border-slate-700 rounded-lg p-3 text-xs text-slate-400 focus:ring-sky-500 focus:border-sky-500"
                      aria-label="Extracted text"
                    />
                  </div>
                </div>
              );
            default:
              return null;
          }
        };

        return (
          <main className="min-h-screen w-full flex flex-col items-center justify-center p-4 sm:p-6 lg:p-8">
              <div className="w-full max-w-4xl">
                  <header className="text-center mb-8">
                      <h1 className="text-4xl sm:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-sky-400 to-emerald-500">
                          AI Document Summarizer
                      </h1>
                      <p className="text-slate-400 mt-2 max-w-2xl mx-auto">
                          An intelligent web application that uses Google's Gemini API to provide a concise summary of your documents.
                      </p>
                  </header>
                  
                  <div className="relative bg-slate-800/50 border border-slate-700 rounded-xl shadow-2xl shadow-slate-950/50 min-h-[400px] flex items-center justify-center transition-all duration-300">
                      {renderContent()}
                  </div>
                  
                  {(processingState !== ProcessingState.IDLE && processingState !== ProcessingState.INITIALIZING) && (
                      <div className="text-center mt-6">
                          <button
                              onClick={resetState}
                              className="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-6 rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-900 focus:ring-sky-500"
                          >
                              Process Another Document
                          </button>
                      </div>
                  )}
              </div>
          </main>
        );
      };

      // --- Inlined from: index.tsx (Entry Point) ---
      const rootElement = document.getElementById('root');
      if (rootElement) {
          const root = ReactDOM.createRoot(rootElement);
          root.render(
              <React.StrictMode>
                  <App />
              </React.StrictMode>
          );
      } else {
          console.error('Failed to find the root element. The application cannot start.');
      }
    </script>
  </body>
</html>